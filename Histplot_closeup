import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import matplotlib.patches as mpatches
import matplotlib.ticker as ticker
import sys

# Cargar la base de datos procesada
df_final = pd.read_parquet('df_final_procesado.parquet')

# Definir la variable de interés
gen_interes_1 = 'A2M'
if gen_interes_1 not in df_final.columns:
    gen_interes_1 = df_final.columns[10]

# Generar Histograma Comparativo con Doble Zoom
plt.figure(figsize=(14, 8))

# Definir la paleta y los labels
labels_unicos = sorted(df_final['Cluster'].unique())
colores_paleta_vibrante = sns.color_palette('husl', n_colors=len(labels_unicos))

sns.histplot(data=df_final,
             x=gen_interes_1,
             hue='Cluster',
             palette=colores_paleta_vibrante,
             kde=True,
             multiple='stack',
             element='step',
             fill=True,
             alpha=0.6,
             linewidth=1,
             legend=False)

# Estética y Títulos
plt.title(f'Doble Zoom de la Cola de Expresión de {gen_interes_1} (Conteos > 5)',
          fontsize=18,
          fontweight='bold',
          color='#2C3E50')
plt.xlabel(f'Nivel de Expresión de {gen_interes_1}', fontsize=14, color='#34495E')
plt.ylabel('Densidad de Spots / Conteo', fontsize=14, color='#34495E')

plt.xticks(fontsize=11)
plt.yticks(fontsize=11)
plt.grid(axis='y', linestyle='--', alpha=0.7, color='#BDC3C7')

# Aplicar el Doble Zoom
max_expresion = df_final[gen_interes_1].max()
plt.xlim(5, max_expresion + 1)
plt.ylim(0, 200)

# Forzar ticks enteros en el eje X (Al hacer el close up se ponia el eje en numeros decimales)
ax = plt.gca()
ax.xaxis.set_major_locator(ticker.MaxNLocator(integer=True))

# Leyenda manual
handles = [mpatches.Patch(color=colores_paleta_vibrante[i], label=f'Clúster {labels_unicos[i]}')
           for i in range(len(labels_unicos))]

plt.legend(handles=handles,
           title='Clúster',
           bbox_to_anchor=(1.02, 1),
           loc='upper left',
           borderaxespad=0.,
           fontsize=10,
           title_fontsize=12)

plt.tight_layout(rect=[0, 0, 0.88, 1])
plt.savefig('grafico1_histograma_doble_zoom.png', dpi=300)
plt.show()
