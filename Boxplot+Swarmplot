import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import sys
import numpy as np
import matplotlib.patches as mpatches

# Cargar la base de datos procesada
df_final = pd.read_parquet('df_final_procesado.parquet')

# Descubrir el gen más expresado
print("Buscando el gen más expresado...")
metadata_cols = ['Cluster', 'x_coord', 'y_coord']
gene_columns = df_final.columns.drop(metadata_cols, errors='ignore')
gene_sums = df_final[gene_columns].sum()
gen_mas_expresado = gene_sums.idxmax()
print(f"El gen más expresado es: {gen_mas_expresado}")

# Log-Transformación
gen_log_col = f"{gen_mas_expresado}_log1p"
df_final[gen_log_col] = np.log1p(df_final[gen_mas_expresado])

# Generar Boxplot + Swarmplot
plt.figure(figsize=(16, 9))

# Definir la paleta y los labels
labels_unicos = sorted(df_final['Cluster'].unique())
colores_paleta_vibrante = sns.color_palette('husl', n_colors=len(labels_unicos))

# (a) El Boxplot
sns.boxplot(data=df_final,
            x='Cluster',
            y=gen_log_col,
            palette=colores_paleta_vibrante,
            showfliers=False,
            boxprops=dict(alpha=0.7),
            width=0.5)

# (b) El Swarmplot
sns.swarmplot(data=df_final,
              x='Cluster',
              y=gen_log_col,
              color='0.3',
              alpha=0.2,
              s=2)

# Estética y Títulos
plt.title(f'Distribución del Gen más Expresado ({gen_mas_expresado}) por Clúster',
          fontsize=18,
          fontweight='bold',
          color='#2C3E50')
plt.xlabel('Clúster', fontsize=14, color='#34495E')
plt.ylabel(f'Nivel de Expresión (log(UMI + 1))', fontsize=14, color='#34495E')

plt.xticks(fontsize=11)
plt.yticks(fontsize=11)
plt.grid(axis='y', linestyle='--', alpha=0.7, color='#BDC3C7')

# Leyenda manual
handles = [mpatches.Patch(color=colores_paleta_vibrante[i], label=f'Clúster {labels_unicos[i]}')
           for i in range(len(labels_unicos))]

plt.legend(handles=handles,
           title='Clúster',
           bbox_to_anchor=(1.02, 1),
           loc='upper left',
           borderaxespad=0.,
           fontsize=10,
           title_fontsize=12)

plt.tight_layout(rect=[0, 0, 0.88, 1])

# Guardar y mostrar
plt.savefig('graficoboxplot_swarmplot_log_leyenda.png', dpi=300)
plt.show()
